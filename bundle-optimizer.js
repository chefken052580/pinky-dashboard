/**
 * Bundle Optimizer - Minify and bundle CSS/JS for production
 * Run this script to generate optimized bundles
 * 
 * Usage: node bundle-optimizer.js
 */

const fs = require('fs');
const path = require('path');

class BundleOptimizer {
    constructor() {
        this.dashboardDir = __dirname;
        this.distDir = path.join(this.dashboardDir, 'dist');
        this.bundles = {
            'critical.css': [],
            'deferred.css': [],
            'core.js': [],
            'widgets.js': [],
            'bots.js': []
        };
    }

    /**
     * Simple CSS minifier (removes comments, whitespace)
     */
    minifyCSS(css) {
        return css
            .replace(/\/\*[\s\S]*?\*\//g, '') // Remove comments
            .replace(/\s+/g, ' ') // Collapse whitespace
            .replace(/\s*([{}:;,])\s*/g, '$1') // Remove space around punctuation
            .replace(/;}/g, '}') // Remove last semicolon
            .trim();
    }

    /**
     * Simple JS minifier (removes comments, extra whitespace)
     * Note: For production, use terser or uglify-js
     */
    minifyJS(js) {
        return js
            .replace(/\/\*[\s\S]*?\*\//g, '') // Remove block comments
            .replace(/\/\/.*/g, '') // Remove line comments
            .replace(/\n\s*\n/g, '\n') // Remove empty lines
            .replace(/^\s+/gm, '') // Remove leading whitespace
            .trim();
    }

    /**
     * Bundle critical CSS (needed for first paint)
     */
    bundleCriticalCSS() {
        const criticalFiles = [
            'styles.css',
            'mobile-responsive.css',
            'pinky-chat.css',
            'sidebar-styling.css'
        ];

        let bundled = '/* Critical CSS Bundle - Generated by BundleOptimizer */\n';
        
        criticalFiles.forEach(file => {
            const filePath = path.join(this.dashboardDir, file);
            if (fs.existsSync(filePath)) {
                const content = fs.readFileSync(filePath, 'utf8');
                const minified = this.minifyCSS(content);
                bundled += `\n/* ${file} */\n${minified}\n`;
            }
        });

        return bundled;
    }

    /**
     * Bundle deferred CSS (widgets, features)
     */
    bundleDeferredCSS() {
        const deferredFiles = [
            'task-statistics.css',
            'task-history-chart.css',
            'task-analytics.css',
            'system-health-widget.css',
            'changelog-widget.css',
            'token-allocation-widget.css',
            'settings.css',
            'export-package.css',
            'about-page.css'
        ];

        let bundled = '/* Deferred CSS Bundle - Generated by BundleOptimizer */\n';
        
        deferredFiles.forEach(file => {
            const filePath = path.join(this.dashboardDir, file);
            if (fs.existsSync(filePath)) {
                const content = fs.readFileSync(filePath, 'utf8');
                const minified = this.minifyCSS(content);
                bundled += `\n/* ${file} */\n${minified}\n`;
            }
        });

        return bundled;
    }

    /**
     * Bundle core JavaScript (needed immediately)
     */
    bundleCoreJS() {
        const coreFiles = [
            'loading-manager.js',
            'theme-manager.js',
            'renderer.js',
            'performance-loader.js'
        ];

        let bundled = '/* Core JS Bundle - Generated by BundleOptimizer */\n';
        
        coreFiles.forEach(file => {
            const filePath = path.join(this.dashboardDir, file);
            if (fs.existsSync(filePath)) {
                const content = fs.readFileSync(filePath, 'utf8');
                const minified = this.minifyJS(content);
                bundled += `\n/* ${file} */\n${minified}\n`;
            }
        });

        return bundled;
    }

    /**
     * Generate bundle report
     */
    generateReport() {
        const report = {
            timestamp: new Date().toISOString(),
            bundles: {},
            totalSize: 0,
            originalSize: 0,
            savings: 0
        };

        // Calculate sizes
        const files = fs.readdirSync(this.dashboardDir).filter(f => 
            f.endsWith('.css') || f.endsWith('.js')
        );

        files.forEach(file => {
            const stats = fs.statSync(path.join(this.dashboardDir, file));
            report.originalSize += stats.size;
        });

        // Check dist directory
        if (fs.existsSync(this.distDir)) {
            const distFiles = fs.readdirSync(this.distDir);
            distFiles.forEach(file => {
                const stats = fs.statSync(path.join(this.distDir, file));
                report.bundles[file] = `${(stats.size / 1024).toFixed(2)} KB`;
                report.totalSize += stats.size;
            });
        }

        report.originalSize = `${(report.originalSize / 1024).toFixed(2)} KB`;
        report.totalSize = `${(report.totalSize / 1024).toFixed(2)} KB`;
        report.savings = `${((1 - parseFloat(report.totalSize) / parseFloat(report.originalSize)) * 100).toFixed(1)}%`;

        return report;
    }

    /**
     * Create optimized bundles
     */
    async optimize() {
        console.log('üîß Starting bundle optimization...\n');

        // Create dist directory
        if (!fs.existsSync(this.distDir)) {
            fs.mkdirSync(this.distDir);
        }

        // Bundle critical CSS
        console.log('üì¶ Bundling critical CSS...');
        const criticalCSS = this.bundleCriticalCSS();
        fs.writeFileSync(path.join(this.distDir, 'critical.css'), criticalCSS);
        console.log(`   ‚úì critical.css: ${(criticalCSS.length / 1024).toFixed(2)} KB`);

        // Bundle deferred CSS
        console.log('üì¶ Bundling deferred CSS...');
        const deferredCSS = this.bundleDeferredCSS();
        fs.writeFileSync(path.join(this.distDir, 'deferred.css'), deferredCSS);
        console.log(`   ‚úì deferred.css: ${(deferredCSS.length / 1024).toFixed(2)} KB`);

        // Bundle core JS
        console.log('üì¶ Bundling core JavaScript...');
        const coreJS = this.bundleCoreJS();
        fs.writeFileSync(path.join(this.distDir, 'core.js'), coreJS);
        console.log(`   ‚úì core.js: ${(coreJS.length / 1024).toFixed(2)} KB`);

        // Generate report
        console.log('\nüìä Bundle Report:');
        const report = this.generateReport();
        console.log(JSON.stringify(report, null, 2));

        console.log('\n‚úÖ Bundle optimization complete!');
        console.log(`üìÅ Bundles saved to: ${this.distDir}`);
    }
}

// Run if called directly
if (require.main === module) {
    const optimizer = new BundleOptimizer();
    optimizer.optimize().catch(console.error);
}

module.exports = BundleOptimizer;
